{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the WaCRM platform.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user entity."
        },
        "name": {
          "type": "string",
          "description": "The user's full name."
        },
        "email": {
          "type": "string",
          "description": "The user's email address.",
          "format": "email"
        },
        "role": {
          "type": "string",
          "description": "The user's role within the system (e.g., ADMIN, AGENT)."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the user account was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp indicating when the user account was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "name",
        "email",
        "role",
        "createdAt",
        "updatedAt"
      ]
    },
    "WhatsAppSession": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "WhatsAppSession",
      "type": "object",
      "description": "Represents a WhatsApp session for a user.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the WhatsApp session."
        },
        "sessionId": {
          "type": "string",
          "description": "Unique session ID generated by WhatsApp."
        },
        "ownerId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N WhatsAppSession)"
        },
        "qr": {
          "type": "string",
          "description": "QR code for initiating the WhatsApp session."
        },
        "isReady": {
          "type": "boolean",
          "description": "Indicates whether the WhatsApp session is ready."
        },
        "sharedWith": {
          "type": "array",
          "description": "References to Users with whom the session is shared. (Relationship: User N:N WhatsAppSession)",
          "items": {
            "type": "string"
          }
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the session was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp indicating when the session was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "sessionId",
        "ownerId",
        "isReady",
        "sharedWith",
        "createdAt",
        "updatedAt"
      ]
    },
    "Chat": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Chat",
      "type": "object",
      "description": "Represents a chat session.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the chat."
        },
        "remoteId": {
          "type": "string",
          "description": "WhatsApp chat ID."
        },
        "name": {
          "type": "string",
          "description": "Name of the chat (if available)."
        },
        "type": {
          "type": "string",
          "description": "Type of chat (INDIVIDUAL or GROUP)."
        },
        "status": {
          "type": "string",
          "description": "Status of the chat (INBOX, DONE, ARCHIVED)."
        },
        "isGroup": {
          "type": "boolean",
          "description": "Indicates whether the chat is a group chat."
        },
        "isRead": {
          "type": "boolean",
          "description": "Indicates whether the chat has been read."
        },
        "isMuted": {
          "type": "boolean",
          "description": "Indicates whether the chat is muted."
        },
        "isArchived": {
          "type": "boolean",
          "description": "Indicates whether the chat is archived."
        },
        "label": {
          "type": "string",
          "description": "Label associated with the chat."
        },
        "lastMessageAt": {
          "type": "string",
          "description": "Timestamp of the last message in the chat.",
          "format": "date-time"
        },
        "sessionId": {
          "type": "string",
          "description": "Reference to WhatsAppSession. (Relationship: WhatsAppSession 1:N Chat)"
        },
        "assignedTo": {
          "type": "string",
          "description": "Reference to User assigned to the chat. (Relationship: User 1:N Chat)"
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the chat was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp indicating when the chat was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "remoteId",
        "type",
        "status",
        "isGroup",
        "isRead",
        "isMuted",
        "isArchived",
        "lastMessageAt",
        "sessionId",
        "createdAt",
        "updatedAt"
      ]
    },
    "Message": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Message",
      "type": "object",
      "description": "Represents a message within a chat.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the message."
        },
        "chatId": {
          "type": "string",
          "description": "Reference to Chat. (Relationship: Chat 1:N Message)"
        },
        "sender": {
          "type": "string",
          "description": "Phone number of the message sender."
        },
        "body": {
          "type": "string",
          "description": "Content of the message."
        },
        "timestamp": {
          "type": "string",
          "description": "Timestamp of when the message was sent.",
          "format": "date-time"
        },
        "isFromUs": {
          "type": "boolean",
          "description": "Indicates whether the message was sent by the current user."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User who sent the message. (Relationship: User 1:N Message)"
        },
        "sessionId": {
          "type": "string",
          "description": "The id of the Whatsapp session that this message belongs to."
        },
        "mediaType": {
          "type": "string",
          "description": "Type of media attached to the message (image, video, audio, document)."
        },
        "mediaUrl": {
          "type": "string",
          "description": "URL of the media file stored in Firebase Storage.",
          "format": "uri"
        },
        "mediaName": {
          "type": "string",
          "description": "Name of the media file."
        },
        "mediaSize": {
          "type": "number",
          "description": "Size of the media file in bytes."
        },
        "caption": {
          "type": "string",
          "description": "Caption associated with the media file."
        },
        "status": {
          "type": "string",
          "description": "Status of the message (sent, delivered, read)."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the message was created.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "chatId",
        "sender",
        "timestamp",
        "isFromUs",
        "sessionId",
        "status",
        "createdAt"
      ]
    },
    "Bot": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Bot",
      "type": "object",
      "description": "Represents an automated bot.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the bot."
        },
        "name": {
          "type": "string",
          "description": "Name of the bot."
        },
        "type": {
          "type": "string",
          "description": "Type of bot (welcome, auto, survey, ai)."
        },
        "config": {
          "type": "string",
          "description": "Configuration settings for the bot."
        },
        "aiEnabled": {
          "type": "boolean",
          "description": "Indicates whether AI is enabled for the bot."
        },
        "aiModel": {
          "type": "string",
          "description": "AI model used by the bot (e.g., gpt-4o-mini)."
        },
        "aiPrompt": {
          "type": "string",
          "description": "AI prompt for the bot."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User who created the bot. (Relationship: User 1:N Bot)"
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the bot was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp indicating when the bot was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "name",
        "type",
        "aiEnabled",
        "aiModel",
        "userId",
        "createdAt",
        "updatedAt"
      ]
    },
    "Contact": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Contact",
      "type": "object",
      "description": "Represents a contact.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the contact."
        },
        "name": {
          "type": "string",
          "description": "Name of the contact."
        },
        "phone": {
          "type": "string",
          "description": "Phone number of the contact (unique per user)."
        },
        "email": {
          "type": "string",
          "description": "Email address of the contact.",
          "format": "email"
        },
        "userId": {
          "type": "string",
          "description": "Reference to User who owns the contact. (Relationship: User 1:N Contact)"
        },
        "categoryId": {
          "type": "string",
          "description": "Reference to Category the contact belongs to. (Relationship: Category 1:N Contact)"
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the contact was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp indicating when the contact was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "name",
        "phone",
        "userId",
        "createdAt",
        "updatedAt"
      ]
    },
    "Conversation": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Conversation",
      "type": "object",
      "description": "Represents a conversation history with a contact.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the conversation."
        },
        "contactId": {
          "type": "string",
          "description": "Reference to Contact the conversation is with. (Relationship: Contact 1:N Conversation)"
        },
        "messages": {
          "type": "array",
          "description": "Array of message objects in the conversation.",
          "items": {
            "type": "string"
          }
        },
        "userId": {
          "type": "string",
          "description": "Reference to User who owns the conversation. (Relationship: User 1:N Conversation)"
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the conversation was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp indicating when the conversation was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "contactId",
        "messages",
        "userId",
        "createdAt",
        "updatedAt"
      ]
    },
    "Category": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Category",
      "type": "object",
      "description": "Represents a category for organizing contacts.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the category."
        },
        "name": {
          "type": "string",
          "description": "Name of the category (unique per user)."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User who owns the category. (Relationship: User 1:N Category)"
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the category was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp indicating when the category was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "name",
        "userId",
        "createdAt",
        "updatedAt"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Represents a user of the WaCRM platform.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/whatsappSessions/{sessionId}",
        "definition": {
          "entityName": "WhatsAppSession",
          "schema": {
            "$ref": "#/backend/entities/WhatsAppSession"
          },
          "description": "Represents a WhatsApp session for a user. Includes denormalized 'ownerId' and 'sharedWith' for authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "sessionId",
              "description": "The unique identifier of the WhatsApp session."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/whatsappSessions/{sessionId}/chats/{chatId}",
        "definition": {
          "entityName": "Chat",
          "schema": {
            "$ref": "#/backend/entities/Chat"
          },
          "description": "Represents a chat session within a WhatsApp session.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "sessionId",
              "description": "The unique identifier of the WhatsApp session."
            },
            {
              "name": "chatId",
              "description": "The unique identifier of the chat."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/whatsappSessions/{sessionId}/chats/{chatId}/messages/{messageId}",
        "definition": {
          "entityName": "Message",
          "schema": {
            "$ref": "#/backend/entities/Message"
          },
          "description": "Represents a message within a chat session. The message includes the 'sessionId' and 'userId' to validate against the ownership.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "sessionId",
              "description": "The unique identifier of the WhatsApp session."
            },
            {
              "name": "chatId",
              "description": "The unique identifier of the chat."
            },
            {
              "name": "messageId",
              "description": "The unique identifier of the message."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/bots/{botId}",
        "definition": {
          "entityName": "Bot",
          "schema": {
            "$ref": "#/backend/entities/Bot"
          },
          "description": "Represents an automated bot. Includes 'userId' for authorization.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "botId",
              "description": "The unique identifier of the bot."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/contacts/{contactId}",
        "definition": {
          "entityName": "Contact",
          "schema": {
            "$ref": "#/backend/entities/Contact"
          },
          "description": "Represents a contact. Includes 'userId' for authorization.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "contactId",
              "description": "The unique identifier of the contact."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/conversations/{conversationId}",
        "definition": {
          "entityName": "Conversation",
          "schema": {
            "$ref": "#/backend/entities/Conversation"
          },
          "description": "Represents a conversation history with a contact. Includes 'userId' for authorization.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "conversationId",
              "description": "The unique identifier of the conversation."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/categories/{categoryId}",
        "definition": {
          "entityName": "Category",
          "schema": {
            "$ref": "#/backend/entities/Category"
          },
          "description": "Represents a category for organizing contacts. Includes 'userId' for authorization.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "categoryId",
              "description": "The unique identifier of the category."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore data structure is designed to support a WhatsApp CRM platform with a focus on real-time chat, AI-powered bots, and customer relationship management features, while adhering to the principles of Authorization Independence, Clarity of Intent, DBAC (Database-Based Access Control), and QAPs (Rules are Not Filters).\n\n**Authorization Independence (Denormalization):**\n\n*   **WhatsApp Sessions:** The `whatsappSessions` collection includes the `ownerId` and `sharedWith` fields. This denormalization allows security rules to determine access based on the user's ID without needing to perform `get()` operations to retrieve parent document data. The `ownerId` specifies who owns the session. The `sharedWith` field is an array of user IDs that the session is shared with. This enables collaborative access to the session without complex rule evaluations.\n*   **Chats & Messages:** `chats` does not contain the `ownerId` or `sharedWith`. Instead, security rules must validate ownership up the chain in `whatsappSessions/{sessionId}` to ensure that the user has the right to interact with the `chat` and its nested `messages`. This assumes chats are scoped to sessions. Each `message` contains the `userId` and `sessionId` to enable validation that the `message` belongs to a `session` owned by the `user`.\n*   **Bots, Contacts, Conversations, Categories:** These collections all contain a `userId` field, indicating the owner of the entity. This allows straight-forward security rules to validate if the user owns the entity and has access to it.\n\n**Structural Segregation (Homogeneous Security Posture):**\n\n*   The structure segregates user-owned data into path-based hierarchies (e.g., `/users/{userId}/whatsappSessions/{sessionId}`), ensuring that each collection has a consistent security posture. This simplifies security rules and reduces the risk of accidentally exposing data.\n\n**Access Modeling (Standardization and Consistency):**\n\n*   **Ownership:** Path-based ownership (`/users/{userId}/...`) is used for private user data. The `ownerId` field in `whatsappSessions` and `userId` field in `bots`, `contacts`, `conversations`, and `categories` collections are used to determine ownership.\n\n**QAPs (Rules are not Filters):**\n\n*   The data structure enables secure `list` operations. Since authorization context is denormalized (e.g., `ownerId` in `whatsappSessions`), security rules can efficiently filter based on these fields without needing complex queries or server-side filtering.\n\n**Invariants:**\n\n*   Timestamps (`createdAt`, `updatedAt`) are included in each entity to maintain data integrity and track changes.\n*   The `status` field in the `chats` and `messages` collections explicitly models the state of these entities, making it easier to enforce business logic and prevent invalid state transitions.\n\nThis structure prioritizes simplicity and security, making it easier to write, debug, and maintain Firestore security rules."
  }
}